pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:32000'
        MAVEN_HOME = '/opt/maven'
        PATH = "${MAVEN_HOME}/bin:${env.PATH}:/usr/local/bin"
        MAVEN_OPTS = '-Dmaven.repo.local=/var/jenkins_home/.m2/repository'
    }
    
    stages {
        stage('ğŸš€ Pipeline Start') {
            steps {
                echo 'ğŸ¯ STARTING E-COMMERCE MICROSERVICES CI/CD PIPELINE'
                echo "ğŸ“… Build Date: ${new Date()}"
                echo "ğŸ”¢ Build Number: ${BUILD_NUMBER}"
                echo "ğŸŒ¿ Branch: ${env.BRANCH_NAME ?: 'main'}"
                
                // Clean workspace and checkout fresh code
                cleanWs()
                checkout scm
                
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
                echo "ğŸ“ Commit: ${env.GIT_COMMIT_SHORT}"
            }
        }
        
        stage('ğŸ”§ Environment Verification') {
            steps {
                echo 'ğŸ”§ Verifying Build Environment...'
                sh '''
                    echo "ğŸ“Š Environment Status:"
                    echo "Java Version:"
                    java -version
                    echo "Maven Version:"
                    mvn -version
                    echo "Docker Version:"
                    docker --version
                    echo "kubectl Version:"
                    kubectl version --client
                    echo "Node.js Version:"
                    node --version
                    echo "npm Version:"
                    npm --version
                '''
            }
        }
        
        stage('ğŸ“¦ Build Microservices') {
            parallel {
                stage('ğŸ›ï¸ Product Service') {
                    steps {
                        dir('backend/product-service') {
                            sh '''
                                echo "ğŸ—ï¸ Building Product Service..."
                                mvn clean compile package -DskipTests
                                echo "âœ… Product Service build completed"
                            '''
                        }
                    }
                }
                stage('ğŸ“¦ Inventory Service') {
                    steps {
                        dir('backend/inventory-service') {
                            sh '''
                                echo "ğŸ—ï¸ Building Inventory Service..."
                                mvn clean compile package -DskipTests
                                echo "âœ… Inventory Service build completed"
                            '''
                        }
                    }
                }
                stage('ğŸ›’ Order Service') {
                    steps {
                        dir('backend/order-service') {
                            sh '''
                                echo "ğŸ—ï¸ Building Order Service..."
                                mvn clean compile package -DskipTests
                                echo "âœ… Order Service build completed"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ§ª Run Tests') {
            parallel {
                stage('ğŸ›ï¸ Test Product') {
                    steps {
                        dir('backend/product-service') {
                            sh '''
                                echo "ğŸ§ª Running Product Service tests..."
                                mvn test
                            '''
                        }
                    }
                    post {
                        always {
                            publishTestResults testResultsPattern: 'backend/product-service/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('ğŸ“¦ Test Inventory') {
                    steps {
                        dir('backend/inventory-service') {
                            sh '''
                                echo "ğŸ§ª Running Inventory Service tests..."
                                mvn test
                            '''
                        }
                    }
                    post {
                        always {
                            publishTestResults testResultsPattern: 'backend/inventory-service/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('ğŸ›’ Test Order') {
                    steps {
                        dir('backend/order-service') {
                            sh '''
                                echo "ğŸ§ª Running Order Service tests..."
                                mvn test
                            '''
                        }
                    }
                    post {
                        always {
                            publishTestResults testResultsPattern: 'backend/order-service/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('ğŸ³ Build Docker Images') {
            parallel {
                stage('ğŸ›ï¸ Docker Product') {
                    steps {
                        dir('backend/product-service') {
                            sh '''
                                echo "ğŸ³ Building Product Service Docker image..."
                                docker build -t ${DOCKER_REGISTRY}/product-service:${BUILD_NUMBER} .
                                docker tag ${DOCKER_REGISTRY}/product-service:${BUILD_NUMBER} ${DOCKER_REGISTRY}/product-service:latest
                                echo "âœ… Product Service Docker image built"
                            '''
                        }
                    }
                }
                stage('ğŸ“¦ Docker Inventory') {
                    steps {
                        dir('backend/inventory-service') {
                            sh '''
                                echo "ğŸ³ Building Inventory Service Docker image..."
                                docker build -t ${DOCKER_REGISTRY}/inventory-service:${BUILD_NUMBER} .
                                docker tag ${DOCKER_REGISTRY}/inventory-service:${BUILD_NUMBER} ${DOCKER_REGISTRY}/inventory-service:latest
                                echo "âœ… Inventory Service Docker image built"
                            '''
                        }
                    }
                }
                stage('ğŸ›’ Docker Order') {
                    steps {
                        dir('backend/order-service') {
                            sh '''
                                echo "ğŸ³ Building Order Service Docker image..."
                                docker build -t ${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER} .
                                docker tag ${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER} ${DOCKER_REGISTRY}/order-service:latest
                                echo "âœ… Order Service Docker image built"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to Registry') {
            steps {
                sh '''
                    echo "ğŸ“¤ Pushing Docker images to registry..."
                    
                    # Push Product Service
                    docker push ${DOCKER_REGISTRY}/product-service:${BUILD_NUMBER}
                    docker push ${DOCKER_REGISTRY}/product-service:latest
                    
                    # Push Inventory Service
                    docker push ${DOCKER_REGISTRY}/inventory-service:${BUILD_NUMBER}
                    docker push ${DOCKER_REGISTRY}/inventory-service:latest
                    
                    # Push Order Service
                    docker push ${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER}
                    docker push ${DOCKER_REGISTRY}/order-service:latest
                    
                    echo "âœ… All images pushed successfully"
                '''
            }
        }
        
        stage('â˜¸ï¸ Deploy to Kubernetes') {
            steps {
                sh '''
                    echo "â˜¸ï¸ Deploying to Kubernetes cluster..."
                    
                    # Update deployments with new image tags
                    kubectl set image deployment/product-service product-service=${DOCKER_REGISTRY}/product-service:${BUILD_NUMBER} || echo "Product deployment update failed"
                    kubectl set image deployment/inventory-service inventory-service=${DOCKER_REGISTRY}/inventory-service:${BUILD_NUMBER} || echo "Inventory deployment update failed"
                    kubectl set image deployment/order-service order-service=${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER} || echo "Order deployment update failed"
                    
                    # Wait for rollouts to complete
                    echo "â³ Waiting for deployments to complete..."
                    kubectl rollout status deployment/product-service --timeout=300s || echo "Product rollout timeout"
                    kubectl rollout status deployment/inventory-service --timeout=300s || echo "Inventory rollout timeout"
                    kubectl rollout status deployment/order-service --timeout=300s || echo "Order rollout timeout"
                    
                    echo "âœ… Kubernetes deployment completed"
                '''
            }
        }
        
        stage('ğŸ” Health Check & Verification') {
            steps {
                sh '''
                    echo "ğŸ” Performing health checks..."
                    
                    # Wait for services to be ready
                    sleep 30
                    
                    # Health check endpoints
                    echo "Checking Product Service health..."
                    curl -f http://20.86.144.152:31309/actuator/health || echo "âŒ Product service health check failed"
                    
                    echo "Checking Inventory Service health..."
                    curl -f http://20.86.144.152:31081/actuator/health || echo "âŒ Inventory service health check failed"
                    
                    echo "Checking Order Service health..."
                    curl -f http://20.86.144.152:31004/actuator/health || echo "âŒ Order service health check failed"
                    
                    # Check Kubernetes pod status
                    echo "ğŸ“Š Kubernetes Pod Status:"
                    kubectl get pods -l app=product-service
                    kubectl get pods -l app=inventory-service
                    kubectl get pods -l app=order-service
                    
                    echo "âœ… Health checks completed"
                '''
            }
        }
        
        stage('ğŸ§¹ Cleanup') {
            steps {
                sh '''
                    echo "ğŸ§¹ Cleaning up build artifacts..."
                    
                    # Remove old Docker images to save space
                    docker image prune -f
                    
                    # Clean Maven cache if needed
                    # mvn dependency:purge-local-repository -DactTransitively=false -DreResolve=false
                    
                    echo "âœ… Cleanup completed"
                '''
            }
        }
    }
    
    post {
        always {
            echo '''
            ğŸ“Š ========================================
            ğŸ“Š PIPELINE EXECUTION COMPLETED
            ğŸ“Š ========================================
            
            ğŸ“… Timestamp: ''' + new Date() + '''
            ğŸ”¢ Build Number: ''' + env.BUILD_NUMBER + '''
            ğŸ“ Git Commit: ''' + env.GIT_COMMIT_SHORT + '''
            ğŸŒ¿ Branch: ''' + (env.BRANCH_NAME ?: 'main') + '''
            â±ï¸ Duration: ''' + currentBuild.durationString + '''
            
            ğŸ“‹ Workspace cleaned and ready for next build
            '''
            
            script {
                try {
                    archiveArtifacts artifacts: '**/target/*.jar', allowEmptyArchive: true
                    echo 'ğŸ“¦ Build artifacts archived'
                } catch (Exception e) {
                    echo "ğŸ“¦ No artifacts to archive: ${e.message}"
                }
            }
        }
        success {
            echo '''
                âœ… ========================================
                âœ… PIPELINE SUCCEEDED!
                âœ… ========================================
                
                ğŸ‰ All microservices built and deployed successfully
                ğŸš€ Services are running on Kubernetes cluster
                ğŸ“Š Health checks passed
                
                ğŸ”— Access your services:
                â€¢ Product Service: http://20.86.144.152:31309
                â€¢ Inventory Service: http://20.86.144.152:31081
                â€¢ Order Service: http://20.86.144.152:31004
                '''
        }
        failure {
            script {
                echo '''
                âŒ ========================================
                âŒ PIPELINE FAILED!
                âŒ ========================================
                
                ğŸ“Š FAILURE SUMMARY:
                âŒ Build Number: ''' + env.BUILD_NUMBER + '''
                âŒ Duration: ''' + currentBuild.durationString + '''
                âŒ Git Commit: ''' + env.GIT_COMMIT_SHORT + '''
                
                ğŸ” TROUBLESHOOTING STEPS:
                1. Check the build logs above for specific errors
                2. Verify Docker registry is accessible
                3. Check Kubernetes cluster status
                4. Ensure all dependencies are available
                5. Review application configuration
                
                ğŸ“ Need help? Check the Jenkins console output for detailed error messages.
                '''
            }
        }
        unstable {
            echo 'âš ï¸ Pipeline completed with warnings - check test results'
        }
    }
} 
